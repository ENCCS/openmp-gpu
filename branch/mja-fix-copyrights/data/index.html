<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data environment &mdash; OpenMP for GPU offloading  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script src="../_static/tabs.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Optimizing OpenMP offloaded code" href="../optimization/" />
    <link rel="prev" title="Offloading to GPU" href="../target/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../" class="icon icon-home"> OpenMP for GPU offloading
            <img src="../_static/ENCCS_CSC_logos.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lessons</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/">Why OpenMP offloading?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miniapp/">Heat diffusion mini-app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-architecture/">Introduction to GPU architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiling/">Profiling code for GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/">Offloading to GPU</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-mapping">Data mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-region">Data region</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#structured-data-regions">Structured Data Regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unstructured-data-regions">Unstructured Data Regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#target-update-construct">TARGET UPDATE construct</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#optimize-data-transfers">Optimize Data Transfers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/">Optimizing OpenMP offloaded code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi-gpu/">Multiple GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interoperability/">Working alongside GPU libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting/">Porting code to OpenMP offloading</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">OpenMP for GPU offloading</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
      <li>Data environment</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/openmp-gpu/blob/main/content/data.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="data-environment">
<h1>Data environment<a class="headerlink" href="#data-environment" title="Permalink to this headline"></a></h1>
<div class="admonition-objectives objectives admonition">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand explicit and implicit data movement</p></li>
<li><p>Understand structured and unstructured data clauses</p></li>
<li><p>Understand different mapping types</p></li>
</ul>
</div>
<div class="section" id="data-mapping">
<h2>Data mapping<a class="headerlink" href="#data-mapping" title="Permalink to this headline"></a></h2>
<p>Due to distinct memory spaces on host and device, transferring data
becomes inevitable. A combination of both explicit and implicit data
mapping is used.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MAP</span></code> cluase on a device construct explicitly
specifies how items are mapped from the host to the device data
environment.  The common mapped items consist of arrays(array
sections), scalars, pointers, and structure elements.  The various
forms of the map cluase are summarised in the following table</p>
<table class="colwidths-auto docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">map([map-type]:list)</span></code></p></td>
<td><p><span class="xref std std-doc">map clause</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">map(to:list)</span></code></p></td>
<td><p><span class="xref std std-doc">On entering the region, variables in the list are initialized on the device using the original values from the host</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">map(from:list)</span></code></p></td>
<td><p><span class="xref std std-doc">At the end of the target region, the values from variables in the list are copied into the original variables on the host. On entering the region, the initial value of the variables on the device is not initialized</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">map(tofrom:list)</span></code></p></td>
<td><p><span class="xref std std-doc">the effect of both a map-to and a map-from</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">map(alloc:list)</span></code></p></td>
<td><p><span class="xref std std-doc">On entering the region, data is allocated and uninitialized on the device</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">map(list)</span></code></p></td>
<td><p><span class="xref std std-doc">equivalent to ``map(tofrom:list)``</span></p></td>
</tr>
</tbody>
</table>
<dl class="simple">
<dt>If the variables are not explicitly mapped, the compiler will do it implicitly:</dt><dd><ul class="simple">
<li><p>Since v4.5, scalar is mapped as firstprivate, and the variable is not copied back to the host</p></li>
<li><p>non-scalar variables are mapped with a map-type tofrom</p></li>
<li><p>a C/C++ pointer is mapped as a zero-length array section</p></li>
<li><p>note that only the pointer value is mapped, but not the data it points to</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>When mapping data arrays or pointers, be careful about the array section notation:</dt><dd><ul class="simple">
<li><p>In C/C++: array[lower-bound:length]. The notation :N is equivalent to 0:N.</p></li>
<li><p>In Fortran:array[lower-bound:upper-bound]. The notation :N is equivalent to 1:N.</p></li>
</ul>
</dd>
</dl>
</div>
<div class="admonition-exercise04-explicit-and-implicit-data-mapping exercise important admonition">
<p class="admonition-title">Exercise04: explicit and implicit data mapping</p>
<ol class="arabic simple">
<li><p>explicitly adding the <code class="docutils literal notranslate"><span class="pre">map</span></code> clauses for data transfer between the host and device</p></li>
<li><p>offloading the part where it “calculates the sum”</p></li>
</ol>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* Copyright (c) 2021 ENCCS */</span><span class="w"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#define NX 102400</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecB</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecC</span><span class="p">[</span><span class="n">NX</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cm">/* Initialization of vectors */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">     </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cm">/* dot product of two vectors */</span><span class="w"></span>
<span class="linenos">18</span><span class="w">  </span><span class="cp">#pragma omp target teams distribute</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">     </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">21</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">  </span><span class="cm">/* calculate the sum */</span><span class="w"></span>
<span class="linenos">25</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">27</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The sum is: %8.6f </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="linenos">29</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 2</span><span class="k">program </span><span class="n">dotproduct</span>
<span class="linenos"> 3</span>  <span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">102400</span>
<span class="linenos"> 6</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.2</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vecA</span><span class="p">,</span><span class="n">vecB</span><span class="p">,</span><span class="n">vecC</span>
<span class="linenos"> 9</span>  <span class="kt">real</span>    <span class="kd">::</span> <span class="nb">sum</span>
<span class="linenos">10</span><span class="nb">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="c">! Initialization of vectors</span>
<span class="linenos">13</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">14</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">15</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">16</span>  <span class="k">end do</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="c">! Dot product of two vectors </span>
<span class="linenos">19</span>  <span class="c">!$omp target teams distribute </span>
<span class="linenos">20</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">21</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">22</span>  <span class="k">end do</span>
<span class="linenos">23</span>  <span class="c">!$omp end target teams distribute</span>
<span class="linenos">24</span>
<span class="linenos">25</span>  <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">26</span>  <span class="c">! Calculate the sum </span>
<span class="linenos">27</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">28</span>     <span class="nb">sum</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span>
<span class="linenos">29</span><span class="nb">  </span><span class="k">end do</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="k">  write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;The sum is: &#39;</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="k">end program </span><span class="n">dotproduct</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* Copyright (c) 2021 ENCCS */</span><span class="w"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#define NX 102400</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecB</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecC</span><span class="p">[</span><span class="n">NX</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cm">/* Initialization of vectors */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">     </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cm">/* dot product of two vectors */</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">  </span><span class="cp">#pragma omp target teams distribute map(from:vecC[0:NX]) map(to:vecA[0:NX],vecB[0:NX])</span>
</span><span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">     </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">21</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">  </span><span class="cm">/* calculate the sum */</span><span class="w"></span>
<span class="hll"><span class="linenos">25</span><span class="w">  </span><span class="cp">#pragma omp target map(tofrom:sum)</span>
</span><span class="linenos">26</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">28</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The sum is: %8.6f </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="linenos">30</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 2</span><span class="k">program </span><span class="n">dotproduct</span>
<span class="linenos"> 3</span>  <span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">102400</span>
<span class="linenos"> 6</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.2</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vecA</span><span class="p">,</span><span class="n">vecB</span><span class="p">,</span><span class="n">vecC</span>
<span class="linenos"> 9</span>  <span class="kt">real</span>    <span class="kd">::</span> <span class="nb">sum</span>
<span class="linenos">10</span><span class="nb">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="c">! Initialization of vectors</span>
<span class="linenos">13</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">14</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">15</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">16</span>  <span class="k">end do</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="c">! Dot product of two vectors </span>
<span class="hll"><span class="linenos">19</span>  <span class="c">!$omp target teams distribute map(from:vecC) map(to:vecA,vecB) </span>
</span><span class="linenos">20</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">21</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">22</span>  <span class="k">end do</span>
<span class="linenos">23</span>  <span class="c">!$omp end target teams distribute</span>
<span class="linenos">24</span>
<span class="linenos">25</span>  <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">26</span>  <span class="c">! Calculate the sum</span>
<span class="hll"><span class="linenos">27</span>  <span class="c">!$omp target map(tofrom:sum)</span>
</span><span class="linenos">28</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">29</span>     <span class="nb">sum</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span>
<span class="linenos">30</span><span class="nb">  </span><span class="k">end do</span>
<span class="hll"><span class="linenos">31</span>  <span class="c">!$omp end target</span>
</span><span class="linenos">32</span>  <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;The sum is: &#39;</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="k">end program </span><span class="n">dotproduct</span>
</pre></div>
</div>
</div></div>
</div>
</div>
<div class="section" id="data-region">
<h2>Data region<a class="headerlink" href="#data-region" title="Permalink to this headline"></a></h2>
<p>How the <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> construct creates storage, transfer data, and remove
storage on the device are clasiffied as two categories: structured
data region and unstructured data region.</p>
<div class="section" id="structured-data-regions">
<h3>Structured Data Regions<a class="headerlink" href="#structured-data-regions" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">DATA</span></code> construct is used to create a structured data region
which is convenient for providing persistent data on the device which
could be used for subseqent target constructs.</p>
<div class="admonition-syntax exercise important admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target data clause [clauses]</span>
<span class="w">      </span><span class="n">structured</span><span class="o">-</span><span class="n">block</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">target</span><span class="w"> </span><span class="nl">data</span><span class="p">:]</span><span class="n">scalar</span><span class="o">-</span><span class="n">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="nl">type</span> <span class="p">:]</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">use_device_ptr</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target data clause [clauses]</span>
        <span class="n">structured</span><span class="o">-</span><span class="k">block</span>
<span class="c">!$omp end target data</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span><span class="p">:</span>
<span class="k">if</span><span class="p">(</span> <span class="p">[</span><span class="k">target data</span><span class="p">:]</span><span class="n">scalar</span><span class="o">-</span><span class="kt">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="kt">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="k">type</span> <span class="p">:]</span> <span class="n">list</span><span class="p">)</span>
<span class="n">use_device_ptr</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</div>
</div>
<div class="section" id="unstructured-data-regions">
<h3>Unstructured Data Regions<a class="headerlink" href="#unstructured-data-regions" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">DATA</span></code> construct however is inconvenient in real applications.
The unstructured data constructs (<code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">ENTER</span> <span class="pre">DATA</span></code> and <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">EXIT</span> <span class="pre">DATA</span></code>)
have much more freedom in creating and deleting of data on the device at any appropriate point.</p>
<div class="admonition-syntax exercise important admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target enter data [clauses]</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target exit data [clauses]</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="n">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="nl">type</span> <span class="p">:]</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="nl">type</span><span class="p">:</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">nowait</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target enter data [clauses]</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target exit data [clauses]</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span><span class="p">:</span>
<span class="k">if</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="kt">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="kt">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="k">type</span> <span class="p">:]</span> <span class="n">list</span><span class="p">)</span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="k">type</span><span class="p">:</span><span class="n">list</span><span class="p">)</span>
<span class="n">nowait</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition-keypoints keypoints admonition">
<p class="admonition-title">Keypoints</p>
<dl class="simple">
<dt>Structured Data Region</dt><dd><ul class="simple">
<li><p>start and end points within a single subroutine</p></li>
<li><p>Memory exists within the data region</p></li>
</ul>
</dd>
<dt>Unstructured Data Region</dt><dd><ul class="simple">
<li><p>multiple start and end points across different subroutines</p></li>
<li><p>Memory exists until explicitly deallocated</p></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="target-update-construct">
<h3>TARGET UPDATE construct<a class="headerlink" href="#target-update-construct" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">UPDATE</span></code> construct is used to keep the variable consistent between the host and the device.
Data can be updated within a target regions  with the transfer direction specified in the clause.</p>
<div class="admonition-syntax exercise important admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target update [clause]</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">motion</span><span class="o">-</span><span class="n">clause</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="nl">of</span><span class="p">:</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="n">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">nowait</span><span class="w"></span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="nl">type</span><span class="p">:</span><span class="n">list</span><span class="p">)</span><span class="w"></span>

<span class="n">motion</span><span class="o">-</span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="n">to</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">from</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target udpate clause</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span> <span class="k">is </span><span class="n">motion</span><span class="o">-</span><span class="n">clause</span> <span class="nb">or </span><span class="n">one</span> <span class="n">of</span><span class="p">:</span>
<span class="k">if</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="kt">logical</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">device</span><span class="p">(</span><span class="n">scalar</span><span class="o">-</span><span class="kt">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">nowait</span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="k">type</span><span class="p">:</span><span class="n">list</span><span class="p">)</span>

<span class="n">motion</span><span class="o">-</span><span class="n">clause</span><span class="p">:</span>
<span class="n">to</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">from</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition-exercise05-target-data-structured-region exercise important admonition">
<p class="admonition-title">Exercise05: <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">DATA</span></code> structured region</p>
<p>Create a data region using <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">DATA</span></code> and add <code class="docutils literal notranslate"><span class="pre">map</span></code> clauses for data transfer.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* Copyright (c) 2021 ENCCS */</span><span class="w"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#define NX 102400</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecB</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecC</span><span class="p">[</span><span class="n">NX</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cm">/* Initialization of vectors */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">     </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cm">/* dot product of two vectors */</span><span class="w"></span>
<span class="linenos">18</span><span class="w">     </span><span class="cp">#pragma omp target</span>
<span class="linenos">19</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">21</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="cm">/* Initialization of vectors again */</span><span class="w"></span>
<span class="linenos">24</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">25</span><span class="w">        </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">        </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">     </span><span class="cp">#pragma omp target </span>
<span class="linenos">30</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">        </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">32</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">33</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">  </span><span class="cm">/* calculate the sum */</span><span class="w"></span>
<span class="linenos">35</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">37</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">38</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The sum is: %8.6f </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="linenos">39</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">40</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 2</span><span class="k">program </span><span class="n">dotproduct</span>
<span class="linenos"> 3</span>  <span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">102400</span>
<span class="linenos"> 6</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.2</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vecA</span><span class="p">,</span><span class="n">vecB</span><span class="p">,</span><span class="n">vecC</span>
<span class="linenos"> 9</span>  <span class="kt">real</span>    <span class="kd">::</span> <span class="nb">sum</span>
<span class="linenos">10</span><span class="nb">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="c">! Initialization of vectors</span>
<span class="linenos">13</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">14</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">15</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">16</span>  <span class="k">end do</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="c">! Dot product of two vectors </span>
<span class="linenos">19</span>  <span class="c">!$omp target </span>
<span class="linenos">20</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">21</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">22</span>  <span class="k">end do</span>
<span class="linenos">23</span>  <span class="c">!$omp end target </span>
<span class="linenos">24</span>
<span class="linenos">25</span>  <span class="c">! Initialization of vectors again</span>
<span class="linenos">26</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">27</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">28</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">29</span>  <span class="k">end do</span>
<span class="linenos">30</span>
<span class="linenos">31</span>  <span class="c">!$omp target</span>
<span class="linenos">32</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">33</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">34</span>  <span class="k">end do</span>
<span class="linenos">35</span>  <span class="c">!$omp end target</span>
<span class="linenos">36</span>
<span class="linenos">37</span>  <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">38</span>  <span class="c">! Calculate the sum</span>
<span class="linenos">39</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">40</span>     <span class="nb">sum</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span>
<span class="linenos">41</span><span class="nb">  </span><span class="k">end do</span>
<span class="linenos">42</span><span class="k">  write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F18.6)&#39;</span><span class="p">)</span> <span class="s1">&#39;The sum is: &#39;</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="k">end program </span><span class="n">dotproduct</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* Copyright (c) 2021 ENCCS */</span><span class="w"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#define NX 102400</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecB</span><span class="p">[</span><span class="n">NX</span><span class="p">],</span><span class="n">vecC</span><span class="p">[</span><span class="n">NX</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cm">/* Initialization of vectors */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">     </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cm">/* dot product of two vectors */</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">  </span><span class="cp">#pragma omp target data map(from:vecC[0:NX])</span>
</span><span class="hll"><span class="linenos">19</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">     </span><span class="cp">#pragma omp target map(to:vecA[0:NX],vecB[0:NX])</span>
</span><span class="linenos">21</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">23</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="cm">/* Initialization of vectors again */</span><span class="w"></span>
<span class="linenos">26</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span>
<span class="hll"><span class="linenos">31</span><span class="w">     </span><span class="cp">#pragma omp target map(to:vecA[0:NX],vecB[0:NX])</span>
</span><span class="linenos">32</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">        </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vecA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vecB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">34</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="linenos">35</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">36</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">  </span><span class="cm">/* calculate the sum */</span><span class="w"></span>
<span class="linenos">38</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vecC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">40</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">41</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The sum is: %8.6f </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="linenos">42</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 2</span><span class="k">program </span><span class="n">dotproduct</span>
<span class="linenos"> 3</span>  <span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">102400</span>
<span class="linenos"> 6</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.2</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vecA</span><span class="p">,</span><span class="n">vecB</span><span class="p">,</span><span class="n">vecC</span>
<span class="linenos"> 9</span>  <span class="kt">real</span>    <span class="kd">::</span> <span class="nb">sum</span>
<span class="linenos">10</span><span class="nb">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="c">! Initialization of vectors</span>
<span class="linenos">13</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">14</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">15</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">16</span>  <span class="k">end do</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="c">! Dot product of two vectors </span>
<span class="hll"><span class="linenos">19</span>  <span class="c">!$omp target data map(from:vecC) </span>
</span><span class="hll"><span class="linenos">20</span>  <span class="c">!$omp target map(to:vecA,vecB)</span>
</span><span class="linenos">21</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">22</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">23</span>  <span class="k">end do</span>
<span class="hll"><span class="linenos">24</span>  <span class="c">!$omp end target </span>
</span><span class="linenos">25</span>
<span class="linenos">26</span>  <span class="c">! Initialization of vectors again</span>
<span class="linenos">27</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">28</span>     <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span> 
<span class="linenos">29</span>     <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="linenos">30</span>  <span class="k">end do</span>
<span class="linenos">31</span>
<span class="hll"><span class="linenos">32</span>  <span class="c">!$omp target map(to:vecA,vecB)</span>
</span><span class="linenos">33</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">34</span>     <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">vecA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">vecB</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">35</span>  <span class="k">end do</span>
<span class="linenos">36</span>  <span class="c">!$omp end target</span>
<span class="hll"><span class="linenos">37</span>  <span class="c">!$omp end target data </span>
</span><span class="linenos">38</span>
<span class="linenos">39</span>  <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">40</span>  <span class="c">! Calculate the sum</span>
<span class="linenos">41</span>  <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">42</span>     <span class="nb">sum</span> <span class="o">=</span>  <span class="n">vecC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span>
<span class="linenos">43</span><span class="nb">  </span><span class="k">end do</span>
<span class="linenos">44</span><span class="k">  write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F18.6)&#39;</span><span class="p">)</span> <span class="s1">&#39;The sum is: &#39;</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="k">end program </span><span class="n">dotproduct</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition-exercise06-target-update exercise important admonition">
<p class="admonition-title">Exercise06:  <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">UPDATE</span></code></p>
<p>Trying to figure out the variable values on host and device at each check point.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">Fortran</button><button aria-controls="panel-7-7-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-2" name="7-2" role="tab" tabindex="-1">Solution</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* Copyright (c) 2021 ENCCS */</span><span class="w"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="cp">#pragma omp target data map(tofrom:x)</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="cm">/* check point 1 */</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">                        </span>
<span class="linenos">11</span><span class="cm">/* check point 2 */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="cp">#pragma omp target update to(x)       </span>
<span class="linenos">13</span><span class="cm">/* check point 3 */</span><span class="w"></span>
<span class="linenos">14</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 2</span><span class="k">program </span><span class="n">dotproduct</span>
<span class="linenos"> 3</span>  <span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">x</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 8</span>  <span class="c">!$omp target data map(tofrom:x) </span>
<span class="linenos"> 9</span>  <span class="c">! check point 1 </span>
<span class="linenos">10</span>  <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>                        
<span class="linenos">11</span>  <span class="c">! check point 2 </span>
<span class="linenos">12</span>  <span class="c">!$omp target update to(x)       </span>
<span class="linenos">13</span>  <span class="c">! check point 3 </span>
<span class="linenos">14</span>  <span class="c">!$omp end target data</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="k">end program </span><span class="n">dotproduct</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-7-7-2" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-2" name="7-2" role="tabpanel" tabindex="0"><table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 27%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>check point</p></th>
<th class="head"><p>x on host</p></th>
<th class="head"><p>x on device</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>check point1</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>check point2</p></td>
<td><p>10</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>check point3</p></td>
<td><p>10</p></td>
<td><p>10</p></td>
</tr>
</tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="optimize-data-transfers">
<h2>Optimize Data Transfers<a class="headerlink" href="#optimize-data-transfers" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Explicitely map the data instead of using the implicit mapping</p></li>
<li><p>Reduce the amount of data mapping between host and device, get
rid of unneeded data transfer</p></li>
<li><p>Try to keep data environment residing on the target device as long
as possible</p></li>
</ul>
<div class="admonition-exercise-data-movement exercise important admonition">
<p class="admonition-title">Exercise: Data Movement</p>
<p>This exercise is about optimization and explicitly moving the data using
the “target data” family constructs. Three incomplete functions are added
to explicitly move the data around in core.cpp or core.F90. You need to
add the directives for data movement for them.</p>
<p>The exercise is under /content/exercise/data_mapping</p>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-8-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-8-8-0" name="8-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-8-8-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-8-8-1" name="8-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-8-8-0" class="sphinx-tabs-panel" id="panel-8-8-0" name="8-0" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Copyright (c) 2019 CSC Training</span>
<span class="linenos"> 2</span><span class="c1">// Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 3</span><span class="c1">// Main solver routines for heat equation solver</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;heat.h&quot;</span><span class="cp"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c1">// Update the temperature values using five-point stencil</span>
<span class="linenos"> 8</span><span class="c1">// Arguments:</span>
<span class="linenos"> 9</span><span class="c1">//   curr: current temperature values</span>
<span class="linenos">10</span><span class="c1">//   prev: temperature values from previous time step</span>
<span class="linenos">11</span><span class="c1">//   a: diffusivity</span>
<span class="linenos">12</span><span class="c1">//   dt: time step</span>
<span class="linenos">13</span><span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="c1">// Help the compiler avoid being confused by the structs</span>
<span class="linenos">16</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">currdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">prevdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">  </span><span class="c1">// Determine the temperature field at next time step</span>
<span class="linenos">22</span><span class="w">  </span><span class="c1">// As we have fixed boundary conditions, the outermost gridpoints</span>
<span class="linenos">23</span><span class="w">  </span><span class="c1">// are not updated.</span>
<span class="linenos">24</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">25</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">dy2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">26</span><span class="w">  </span><span class="cp">#pragma omp target teams distribute parallel for </span>
<span class="linenos">27</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">29</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">jp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">      </span><span class="n">currdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="w"></span>
<span class="linenos">35</span><span class="w">	    </span><span class="p">((</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="linenos">36</span><span class="w">	     </span><span class="p">(</span><span class="n">prevdata</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">jm</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dy2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">38</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">39</span><span class="p">}</span><span class="w"></span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="c1">// Start a data region and copy temperature fields to the device </span>
<span class="linenos">42</span><span class="kt">void</span><span class="w"> </span><span class="nf">enter_data</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">43</span><span class="p">{</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span><span class="w"> </span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">currdata</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prevdata</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">currdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="n">prevdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">49</span><span class="w">    </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="linenos">50</span><span class="w">    </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">51</span>
<span class="hll"><span class="linenos">52</span><span class="c1">// adding data mapping here</span>
</span><span class="hll"><span class="linenos">53</span><span class="w">    </span><span class="cp">#pragma omp target enter data \</span>
</span><span class="linenos">54</span><span class="cp">    map(to: currdata[0:(nx+2)*(ny+2)], prevdata[0:(nx+2)*(ny+2)])</span>
<span class="linenos">55</span><span class="p">}</span><span class="w"></span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="c1">// End a data region and copy temperature fields back to the host </span>
<span class="linenos">58</span><span class="kt">void</span><span class="w"> </span><span class="nf">exit_data</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">59</span><span class="p">{</span><span class="w"></span>
<span class="linenos">60</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span><span class="w"> </span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">currdata</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prevdata</span><span class="p">;</span><span class="w"></span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="n">currdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">64</span><span class="w">    </span><span class="n">prevdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">65</span><span class="w">    </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="linenos">66</span><span class="w">    </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">67</span>
<span class="hll"><span class="linenos">68</span><span class="c1">// adding data mapping here</span>
</span><span class="hll"><span class="linenos">69</span><span class="w">    </span><span class="cp">#pragma omp target exit data \</span>
</span><span class="linenos">70</span><span class="cp">    map(from: currdata[0:(nx+2)*(ny+2)], prevdata[0:(nx+2)*(ny+2)])</span>
<span class="linenos">71</span><span class="p">}</span><span class="w"></span>
<span class="linenos">72</span>
<span class="linenos">73</span><span class="c1">// Copy a temperature field from the device to the host </span>
<span class="linenos">74</span><span class="kt">void</span><span class="w"> </span><span class="nf">update_host</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">temperature</span><span class="p">)</span><span class="w"></span>
<span class="linenos">75</span><span class="p">{</span><span class="w"></span>
<span class="linenos">76</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span><span class="w"> </span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">77</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">78</span>
<span class="linenos">79</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="linenos">80</span><span class="w">    </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="linenos">81</span><span class="w">    </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="linenos">82</span>
<span class="hll"><span class="linenos">83</span><span class="c1">// adding data mapping here</span>
</span><span class="linenos">84</span><span class="w">    </span><span class="cp">#pragma omp target update from(data[0:(nx+2)*(ny+2)])</span>
<span class="linenos">85</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-8-8-1" class="sphinx-tabs-panel" hidden="true" id="panel-8-8-1" name="8-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! Copyright (c) 2019 CSC Training</span>
<span class="linenos"> 2</span><span class="c">! Copyright (c) 2021 ENCCS</span>
<span class="linenos"> 3</span><span class="c">! Main solver routines for heat equation solver</span>
<span class="linenos"> 4</span><span class="k">module </span><span class="n">core</span>
<span class="linenos"> 5</span>  <span class="k">use </span><span class="n">heat</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">contains</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="c">! Update the temperature values using five-point stencil</span>
<span class="linenos">10</span>  <span class="c">! Arguments:</span>
<span class="linenos">11</span>  <span class="c">!   curr (type(field)): current temperature values</span>
<span class="linenos">12</span>  <span class="c">!   prev (type(field)): temperature values from previous time step</span>
<span class="linenos">13</span>  <span class="c">!   a (real(dp)): diffusivity</span>
<span class="linenos">14</span>  <span class="c">!   dt (real(dp)): time step</span>
<span class="linenos">15</span>  <span class="k">subroutine </span><span class="n">evolve</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="k">implicit none</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="k">    type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span><span class="k">target</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">,</span> <span class="n">prev</span>
<span class="linenos">20</span>    <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">dt</span>
<span class="linenos">21</span>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span>
<span class="linenos">22</span>    <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>
<span class="linenos">23</span>    <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span><span class="p">,</span> <span class="k">contiguous</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="n">currdata</span><span class="p">,</span> <span class="n">prevdata</span>
<span class="linenos">24</span>
<span class="linenos">25</span>    <span class="c">! Help the compiler avoid being confused</span>
<span class="linenos">26</span>    <span class="n">nx</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">nx</span>
<span class="linenos">27</span>    <span class="n">ny</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">ny</span>
<span class="linenos">28</span>    <span class="n">dx</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">dx</span>
<span class="linenos">29</span>    <span class="n">dy</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">dy</span>
<span class="linenos">30</span>    <span class="n">currdata</span> <span class="o">=&gt;</span> <span class="n">curr</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">31</span><span class="k">    </span><span class="n">prevdata</span> <span class="o">=&gt;</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">32</span>
<span class="linenos">33</span>    <span class="c">! Determine the temperature field at next time step As we have</span>
<span class="linenos">34</span>    <span class="c">! fixed boundary conditions, the outermost gridpoints are not</span>
<span class="hll"><span class="linenos">35</span>    <span class="c">! updated.</span>
</span><span class="linenos">36</span>    <span class="c">!$omp target teams distribute parallel do  </span>
<span class="linenos">37</span>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span>
<span class="linenos">38</span>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
<span class="linenos">39</span>          <span class="n">currdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">&amp;</span>
<span class="linenos">40</span>               <span class="p">&amp;</span> <span class="p">((</span><span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<span class="linenos">41</span>               <span class="p">&amp;</span>   <span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<span class="linenos">42</span>               <span class="p">&amp;</span>  <span class="p">(</span><span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<span class="linenos">43</span>               <span class="p">&amp;</span>   <span class="n">prevdata</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">44</span>       <span class="k">end do</span>
<span class="linenos">45</span><span class="k">    end do</span>
<span class="linenos">46</span>    <span class="c">!$omp end target teams distribute parallel do </span>
<span class="linenos">47</span>  <span class="k">end subroutine </span><span class="n">evolve</span>
<span class="linenos">48</span>
<span class="linenos">49</span>  <span class="c">! Start a data region and copy temperature fields to the device</span>
<span class="linenos">50</span>  <span class="c">!   curr (type(field)): current temperature values</span>
<span class="linenos">51</span>  <span class="c">!   prev (type(field)): values from previous time step</span>
<span class="linenos">52</span>  <span class="k">subroutine </span><span class="n">enter_data</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
<span class="linenos">53</span>    <span class="k">implicit none</span>
<span class="linenos">54</span><span class="k">    type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="k">target</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">,</span> <span class="n">prev</span>
<span class="linenos">55</span>    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span><span class="p">,</span> <span class="k">contiguous</span> <span class="kd">::</span> <span class="n">currdata</span><span class="p">(:,:),</span> <span class="n">prevdata</span><span class="p">(:,:)</span>
<span class="linenos">56</span>
<span class="linenos">57</span>    <span class="n">currdata</span> <span class="o">=&gt;</span> <span class="n">curr</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">58</span><span class="k">    </span><span class="n">prevdata</span> <span class="o">=&gt;</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">59</span>
<span class="hll"><span class="linenos">60</span>  <span class="c">! adding data mapping here</span>
</span><span class="linenos">61</span>    <span class="c">!$omp target enter data map(to: currdata, prevdata)</span>
<span class="linenos">62</span>
<span class="linenos">63</span>  <span class="k">end subroutine </span><span class="n">enter_data</span>
<span class="linenos">64</span>
<span class="linenos">65</span>  <span class="c">! End a data region and copy temperature fields back to the host</span>
<span class="linenos">66</span>  <span class="c">!   curr (type(field)): current temperature values</span>
<span class="linenos">67</span>  <span class="c">!   prev (type(field)): values from previous time step</span>
<span class="linenos">68</span>  <span class="k">subroutine </span><span class="n">exit_data</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
<span class="linenos">69</span>    <span class="k">implicit none</span>
<span class="linenos">70</span><span class="k">    type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">,</span> <span class="n">prev</span>
<span class="linenos">71</span>    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span><span class="p">,</span> <span class="k">contiguous</span> <span class="kd">::</span> <span class="n">currdata</span><span class="p">(:,:),</span> <span class="n">prevdata</span><span class="p">(:,:)</span>
<span class="linenos">72</span>
<span class="linenos">73</span>    <span class="n">currdata</span> <span class="o">=&gt;</span> <span class="n">curr</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">74</span><span class="k">    </span><span class="n">prevdata</span> <span class="o">=&gt;</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">75</span>
<span class="hll"><span class="linenos">76</span>  <span class="c">! adding data mapping here</span>
</span><span class="linenos">77</span>    <span class="c">!$omp target exit data map(from: currdata, prevdata)</span>
<span class="linenos">78</span>
<span class="linenos">79</span>  <span class="k">end subroutine </span><span class="n">exit_data</span>
<span class="linenos">80</span>
<span class="linenos">81</span>  <span class="c">! Copy a temperature field from the device to the host</span>
<span class="linenos">82</span>  <span class="c">!   temperature (type(field)): temperature field</span>
<span class="linenos">83</span>  <span class="k">subroutine </span><span class="n">update_host</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
<span class="linenos">84</span>    <span class="k">implicit none</span>
<span class="linenos">85</span><span class="k">    type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">temperature</span>
<span class="linenos">86</span>    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span><span class="p">,</span> <span class="k">contiguous</span> <span class="kd">::</span> <span class="n">tempdata</span><span class="p">(:,:)</span>
<span class="linenos">87</span>
<span class="linenos">88</span>    <span class="n">tempdata</span> <span class="o">=&gt;</span> <span class="n">temperature</span><span class="p">%</span><span class="k">data</span>
<span class="linenos">89</span>
<span class="hll"><span class="linenos">90</span>  <span class="c">! adding data mapping here</span>
</span><span class="linenos">91</span>    <span class="c">!$omp target update from(tempdata)</span>
<span class="linenos">92</span>
<span class="linenos">93</span>  <span class="k">end subroutine </span><span class="n">update_host</span>
<span class="linenos">94</span>
<span class="linenos">95</span><span class="k">end module </span><span class="n">core</span>
</pre></div>
</div>
</div></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../target/" class="btn btn-neutral float-left" title="Offloading to GPU" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../optimization/" class="btn btn-neutral float-right" title="Optimizing OpenMP offloaded code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, ENCCS and CSC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>