

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Heat diffusion mini-app &mdash; OpenMP for GPU offloading  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
  <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script src="../_static/tabs.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Offloading to GPU" href="../target/" />
    <link rel="prev" title="OpenMP for GPU offloading" href="../" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../" class="icon icon-home"> OpenMP for GPU offloading
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">The lessons</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Heat diffusion mini-app</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#heat-diffusion">Heat diffusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-partial-differential-equation">The partial differential equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-boundary-conditions">Spatial boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-source-code">The source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-code">Building the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-the-code">Running the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-and-boundary-conditions">Initial and boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualizing-the-output">Visualizing the output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../target/">Offloading to GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/">Data environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">OpenMP for GPU offloading</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
        
      <li>Heat diffusion mini-app</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/ENCCS/openmp-gpu/blob/main/content/miniapp.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="heat-diffusion-mini-app">
<h1>Heat diffusion mini-app<a class="headerlink" href="#heat-diffusion-mini-app" title="Permalink to this headline">¶</a></h1>
<div class="admonition-questions questions admonition">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>How can I learn about OpenMP on GPUs with a practical example?</p></li>
<li><p>What should I think about when porting code to use GPUs?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand the structure of a mini-app that models heat diffusion</p></li>
<li><p>Understand how the 5-point stencil operates</p></li>
<li><p>Understand that the loops influence the duration of the mini-app</p></li>
<li><p>Understand the expected output of the mini-app</p></li>
</ul>
</div>
<div class="admonition-prerequisites prerequisites admonition">
<p class="admonition-title">Prerequisites</p>
<ol class="arabic simple">
<li><p>Understanding of how to read either C++ or Fortran code</p></li>
<li><p>Running programs from a terminal command line</p></li>
</ol>
</div>
<div class="section" id="heat-diffusion">
<h2>Heat diffusion<a class="headerlink" href="#heat-diffusion" title="Permalink to this headline">¶</a></h2>
<p>Heat flows in objects according to local temperature differences, as if seeking local equilibrium.
Such processes can be modelled with partial differential equations via discretization to a regular grid.
Solving for the flow over time can involve a lot of computational effort.
Fortunately that effort is quite regular and so can suit parallelization with a variety of techniques.
That includes OpenMP offload to GPUs, so first we will introduce this mini-app and then use it to explore OpenMP offload</p>
</div>
<div class="section" id="the-partial-differential-equation">
<h2>The partial differential equation<a class="headerlink" href="#the-partial-differential-equation" title="Permalink to this headline">¶</a></h2>
<p>The rate of change of the temperature field <span class="math notranslate nohighlight">\(u(x, y, t)\)</span> over two spatial
dimensions <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> and time <span class="math notranslate nohighlight">\(t\)</span>
with diffusivity <span class="math notranslate nohighlight">\(\alpha\)</span> can be modelled via the equation</p>
<div class="math notranslate nohighlight">
\[\frac{\partial u}{\partial t} = \alpha \nabla^2 u\]</div>
<p>where <span class="math notranslate nohighlight">\(\nabla\)</span> is the Laplacian operator, which describes how
the temperature field varies with the spatial dimensions <span class="math notranslate nohighlight">\(x\)</span> and
<span class="math notranslate nohighlight">\(y\)</span>. When those are continuous variables, that looks like</p>
<div class="math notranslate nohighlight">
\[\frac{\partial u}{\partial t} = \alpha \left( \frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial x^2}\right)\]</div>
<p>Because computers are finite devices, we often need to solve such equations numerically, rather than analytically.
This often involves <em>discretization</em>, where spatial and temporal variables only take on specific values from a set.
In this mini-app we will discretize all three dimensions <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, and <span class="math notranslate nohighlight">\(t\)</span>, such that</p>
<div class="math notranslate nohighlight">
\[\begin{split}\nabla^2 u  &amp;= \frac{u(i-1,j)-2u(i,j)+u(i+1,j)}{(\Delta x)^2} \\
    &amp;+ \frac{u(i,j-1)-2u(i,j)+u(i,j+1)}{(\Delta y)^2}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(u(i,j)\)</span> refers to the temperature at location with
integer index <span class="math notranslate nohighlight">\(i\)</span> within the domain of <span class="math notranslate nohighlight">\(x\)</span> spaced by
<span class="math notranslate nohighlight">\(\Delta x\)</span> and location with integer index <span class="math notranslate nohighlight">\(j\)</span> within the
domain of <span class="math notranslate nohighlight">\(y\)</span> spaced by <span class="math notranslate nohighlight">\(\Delta y\)</span>.</p>
<p>Given an initial condition <span class="math notranslate nohighlight">\((u^{t=0})\)</span>, one can follow the time
dependence of the temperature field from state <span class="math notranslate nohighlight">\(m\)</span> to
<span class="math notranslate nohighlight">\(m+1\)</span> over regular time steps <span class="math notranslate nohighlight">\(\Delta t\)</span> with explicit
time evolution method:</p>
<div class="math notranslate nohighlight">
\[u^{m+1}(i,j) = u^m(i,j) + \Delta t \alpha \nabla^2 u^m(i,j)\]</div>
<p>This equation expresses that the time evolution of the temperature
field at a particular location depends on the value of the field at
the previous step at the same location <em>and</em> four adjacent locations:</p>
<div class="figure align-center" id="id1">
<img alt="../_images/stencil.svg" src="../_images/stencil.svg" /><p class="caption"><span class="caption-text">This example model uses an 8x8 grid of data in light blue in state
<span class="math notranslate nohighlight">\(m\)</span>, each location of which has to be updated based on the
indicated 5-point stencil in yellow to move to the next time point
<span class="math notranslate nohighlight">\(m+1\)</span>.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition-exercise exercise important admonition">
<p class="admonition-title">Exercise</p>
<p>How much arithmetic must be done to evolve each location at each time step?</p>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<p>10 arithmetic operations per location per time step. 3 in each of 2
numerators, 1 to divide by each pre-computed denominator, and two
additions to update <span class="math notranslate nohighlight">\(u\)</span>.</p>
</div>
<div class="admonition-exercise exercise important admonition">
<p class="admonition-title">Exercise</p>
<p>How much arithmetic must be done to evolve all locations in the grid for 20 steps?</p>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<p>There’s 64 locations and 20 steps and each does the same 10
operations, so <span class="math notranslate nohighlight">\(10*8*8*20 = 12800\)</span> arithmetic operations
total.</p>
</div>
</div>
<div class="section" id="spatial-boundary-conditions">
<h2>Spatial boundary conditions<a class="headerlink" href="#spatial-boundary-conditions" title="Permalink to this headline">¶</a></h2>
<p>Something must happen at the edges of the grid so that the stencil does a valid operation.
One alternative is to ignore the contribution of points that are outside the grid.
However, this tends to complicate the implementation of the stencil and is also often non-physical.
In a real problem, there is always somethign outside the grid!
Sometimes it makes sense to have periodic boundaries to the grid, but that is complex to implement.
In this mini-app, we will have a ring of data points around the grid.
Those will have a fixed value that is not updated by the stencil,
although they do contribute to the stencil operation for their neighbors.</p>
<div class="figure align-center" id="id2">
<img alt="../_images/stencil-fixed-boundaries.svg" src="../_images/stencil-fixed-boundaries.svg" /><p class="caption"><span class="caption-text">This example model uses an 8x8 grid of data in light blue with an
outer ring in red of boundary grid sites whose temperature values
are fixed. This lets the stencil operate on the blue region in a
straightforward way.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="the-source-code">
<h2>The source code<a class="headerlink" href="#the-source-code" title="Permalink to this headline">¶</a></h2>
<p>Now we’ll take a look at the source code that will do this for us!
Let’s look at the data structure describing the field:</p>
<div class="admonition-the-field-data-structure typealong toggle-shown dropdown admonition">
<p class="admonition-title">The field data structure</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">field</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// nx and ny are the dimensions of the field. The array data</span>
<span class="w">    </span><span class="c1">// contains also ghost layers, so it will have dimensions nx+2 x ny+2</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Size of the grid cells</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// The temperature values in the 2D grid</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>  <span class="k">type</span> <span class="kd">::</span> <span class="n">field</span>
     <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nx</span>          <span class="c">! ldimension of the field</span>
     <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ny</span>
     <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dx</span>
     <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dy</span>
     <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="k">data</span>
<span class="k">  end type </span><span class="n">field</span>
</pre></div>
</div>
</div></div>
</div>
<p>Next, the routine that applies the stencil to the previous field to compute the current one:</p>
<div class="admonition-the-core-evolution-operation typealong toggle-shown dropdown admonition">
<p class="admonition-title">The core evolution operation</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Update the temperature values using five-point stencil</span>
<span class="c1">// Arguments:</span>
<span class="c1">//   curr: current temperature values</span>
<span class="c1">//   prev: temperature values from previous time step</span>
<span class="c1">//   a: diffusivity</span>
<span class="c1">//   dt: time step</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Help the compiler avoid being confused by the structs</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">currdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">prevdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">nx</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Determine the temperature field at next time step</span>
<span class="w">  </span><span class="c1">// As we have fixed boundary conditions, the outermost gridpoints</span>
<span class="w">  </span><span class="c1">// are not updated.</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">dy2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">jp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">currdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="w"></span>
<span class="w">	    </span><span class="p">((</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">	     </span><span class="p">(</span><span class="n">prevdata</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">prevdata</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">prevdata</span><span class="p">[</span><span class="n">jm</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dy2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>  <span class="c">! Update the temperature values using five-point stencil</span>
  <span class="c">! Arguments:</span>
  <span class="c">!   curr (type(field)): current temperature values</span>
  <span class="c">!   prev (type(field)): temperature values from previous time step</span>
  <span class="c">!   a (real(dp)): diffusivity</span>
  <span class="c">!   dt (real(dp)): time step</span>
  <span class="k">subroutine </span><span class="n">evolve</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">,</span> <span class="n">prev</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">dt</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span>

    <span class="c">! Help the compiler avoid being confused</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">nx</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">curr</span><span class="p">%</span><span class="n">ny</span>

    <span class="c">! Determine the temperature field at next time step As we have</span>
    <span class="c">! fixed boundary conditions, the outermost gridpoints are not</span>
    <span class="c">! updated.</span>
    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span>
       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span>
          <span class="n">curr</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">&amp;</span>
               <span class="p">&amp;</span> <span class="p">((</span><span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
               <span class="p">&amp;</span>   <span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="o">/</span> <span class="n">curr</span><span class="p">%</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
               <span class="p">&amp;</span>  <span class="p">(</span><span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
               <span class="p">&amp;</span>   <span class="n">prev</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">curr</span><span class="p">%</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
       <span class="k">end do</span>
<span class="k">    end do</span>
<span class="k">  end subroutine </span><span class="n">evolve</span>
</pre></div>
</div>
</div></div>
</div>
<p>Then the routine that handles the main loop over time steps:</p>
<div class="admonition-the-main-driver-function typealong toggle-shown dropdown admonition">
<p class="admonition-title">The main driver function</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Number of time steps</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nsteps</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Current and previous temperature fields</span>
<span class="w">    </span><span class="n">field</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">previous</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nsteps</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Diffusion constant</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Compute the largest stable time step</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dy2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Time step</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dx2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dy2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">dx2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy2</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Time evolution</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nsteps</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">evolve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Swap current field so that it will be used</span>
<span class="w">        </span><span class="c1">// as previous for next iteration step</span>
<span class="w">        </span><span class="n">swap_fields</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">! Heat equation solver in 2D.</span>

<span class="k">program </span><span class="n">heat_solve</span>
  <span class="k">use </span><span class="n">heat</span>
  <span class="k">use </span><span class="n">core</span>
  <span class="k">use </span><span class="n">io</span>
  <span class="k">use </span><span class="n">setup</span>
  <span class="k">use </span><span class="n">utilities</span>
  <span class="k">use </span><span class="n">omp_lib</span>

  <span class="k">implicit none</span>

<span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c">! Diffusion constant</span>
  <span class="k">type</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="kd">::</span> <span class="n">current</span><span class="p">,</span> <span class="n">previous</span>    <span class="c">! Current and previus temperature fields</span>

  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dt</span>     <span class="c">! Time step</span>
  <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nsteps</span>       <span class="c">! Number of time steps</span>

  <span class="kt">integer</span> <span class="kd">::</span> <span class="n">iter</span>

  <span class="k">call </span><span class="n">initialize</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>

  <span class="c">! Largest stable time step</span>
  <span class="n">dt</span> <span class="o">=</span> <span class="n">current</span><span class="p">%</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">current</span><span class="p">%</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">&amp;</span>
       <span class="p">&amp;</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">current</span><span class="p">%</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">current</span><span class="p">%</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

  <span class="c">! Main iteration loop</span>
  <span class="k">do </span><span class="n">iter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span>
     <span class="k">call </span><span class="n">evolve</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
     <span class="k">call </span><span class="n">swap_fields</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
  <span class="k">end do</span>
<span class="k">end program </span><span class="n">heat_solve</span>
</pre></div>
</div>
</div></div>
</div>
<p>There’s other supporting code to handle user input and produce nice images
of the current field, but we won’t need to touch those, so we won’t spend time
looking at them now.
In the real version of the code we have seen, there’s also calls to libraries to record the time taken.
We’ll need that later so we understand how fast our code is.</p>
<p>We should look at the routines that initialize the field data structures:</p>
<div class="admonition-the-setup-routines typealong toggle-shown dropdown admonition">
<p class="admonition-title">The setup routines</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Allocate memory for a temperature field and initialise it to zero</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">allocate_field</span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="o">*</span><span class="n">temperature</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Include also boundary layers</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">temperature</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">newSize</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>    <span class="c">! The arrays for field contain also a halo region</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">field0</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">field0</span><span class="p">%</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">field0</span><span class="p">%</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div></div>
</div>
</div>
<div class="section" id="building-the-code">
<h2>Building the code<a class="headerlink" href="#building-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code is set up so that you can change to its directory,
type <cite>make</cite> and it will build and run for you.</p>
<div class="admonition-building-the-code typealong toggle-shown dropdown admonition">
<p class="admonition-title">Building the code</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> serial
make
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> serial/fortran
make
</pre></div>
</div>
</div></div>
</div>
<p>You will see output something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="o">-</span><span class="n">c</span> <span class="n">main</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">main</span><span class="o">.</span><span class="n">o</span>
<span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="o">-</span><span class="n">c</span> <span class="n">core</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">core</span><span class="o">.</span><span class="n">o</span>
<span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="o">-</span><span class="n">c</span> <span class="n">setup</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">setup</span><span class="o">.</span><span class="n">o</span>
<span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="o">-</span><span class="n">c</span> <span class="n">utilities</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">utilities</span><span class="o">.</span><span class="n">o</span>
<span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="o">-</span><span class="n">c</span> <span class="n">io</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">io</span><span class="o">.</span><span class="n">o</span>
<span class="n">nvc</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">fopenmp</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="o">../</span><span class="n">common</span> <span class="n">main</span><span class="o">.</span><span class="n">o</span> <span class="n">core</span><span class="o">.</span><span class="n">o</span> <span class="n">setup</span><span class="o">.</span><span class="n">o</span> <span class="n">utilities</span><span class="o">.</span><span class="n">o</span> <span class="n">io</span><span class="o">.</span><span class="n">o</span> <span class="o">../</span><span class="n">common</span><span class="o">/</span><span class="n">pngwriter</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">o</span> <span class="n">heat_serial</span>  <span class="o">-</span><span class="n">lpng</span>
</pre></div>
</div>
<p>which produces an executal program called <code class="docutils literal notranslate"><span class="pre">heat_serial</span></code>.</p>
</div>
<div class="section" id="running-the-code">
<h2>Running the code<a class="headerlink" href="#running-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code lets you choose the spatial dimensions and the number of time steps on the command line.
For example, to run an 800 by 800 grid for 1000 steps, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./heat_serial <span class="m">800</span> <span class="m">800</span> <span class="m">1000</span>
</pre></div>
</div>
<p>Try it now!</p>
<div class="admonition-exercise exercise important admonition">
<p class="admonition-title">Exercise</p>
<p>How long does the iteration take if you double the number of steps?
How long does the iteration take if you double the number of grid points in each direction?</p>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<p>Doubling the number of steps doubles the total amount of work, so should take around twice as long.
Doubling both numbers of grid points is four times as much work, so should take around four times as long.</p>
</div>
<p>You can see the output on the terminal, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Average</span> <span class="n">temperature</span> <span class="n">at</span> <span class="n">start</span><span class="p">:</span> <span class="mf">59.762281</span>
<span class="n">Iterations</span> <span class="n">took</span> <span class="mf">0.426</span> <span class="n">seconds</span><span class="o">.</span>
<span class="n">Average</span> <span class="n">temperature</span><span class="p">:</span> <span class="mf">58.065097</span>
</pre></div>
</div>
<p>This report will help us check whether our attempts to optimize made the code faster while keepint it correct.</p>
</div>
<div class="section" id="initial-and-boundary-conditions">
<h2>Initial and boundary conditions<a class="headerlink" href="#initial-and-boundary-conditions" title="Permalink to this headline">¶</a></h2>
<p>When solving PDEs, the initial conditions determine the possible solutions.
The mini-app automatically sets up a disk of cold grid points in the center at temperature 5, with warm grid points around it at temperature 65.</p>
<div class="figure align-center" id="id3">
<img alt="../_images/heat_0000.png" src="../_images/heat_0000.png" />
<p class="caption"><span class="caption-text">Initial conditions of the grid.
The boundary layers are not shown.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>There is a fixed boundary layer of one grid point on all sides, two of which are warm (temperature 70 and 85) and two cold (temperature 20 and 5).
Early on, the disk and its surroundings dominate the contents of the grid, but over time, the boundary layers have greater and greater influence.</p>
<div class="admonition-exercise exercise important admonition">
<p class="admonition-title">Exercise</p>
<p>To which average temperature will the grid converge?</p>
</div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<p>Eventually, the boundary conditions will dominate.
Each contributes equally if the sides are of equal length.
The average of the grid will be the average of the boundaries, ie. <span class="math notranslate nohighlight">\((70+20+85+5)/4\)</span> which is <span class="math notranslate nohighlight">\(45\)</span>.</p>
</div>
</div>
<div class="section" id="visualizing-the-output">
<h2>Visualizing the output<a class="headerlink" href="#visualizing-the-output" title="Permalink to this headline">¶</a></h2>
<p>The mini-app has support for writing an image file that shows the state of the grid every 1500 steps.
Below we can see the progression over larger numbers of steps:</p>
<div class="figure align-center" id="id4">
<img alt="../_images/heat_montage.png" src="../_images/heat_montage.png" />
<p class="caption"><span class="caption-text">Over time, the grid progresses from the initial state toward
an end state where one triangle is cold and one is warm.
The average temperature tends to 45.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>We can use this visualization to check that our attempts at parallelization are working correctly.
Perhaps some bugs can be resolved by seeing what distortions they introduce.</p>
<div class="admonition-keypoints keypoints admonition">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>The heat equation is discretized in space and time</p></li>
<li><p>The implementation has loops over time and spatial dimensions</p></li>
<li><p>The implementation reports on the contents of the grid so we can understand correctness and performance easily.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../target/" class="btn btn-neutral float-right" title="Offloading to GPU" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../" class="btn btn-neutral float-left" title="OpenMP for GPU offloading" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, ENCCS and CSC.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>