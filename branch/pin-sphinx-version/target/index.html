

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Offloading to GPU &mdash; OpenMP for GPU offloading  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
  <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script src="../_static/tabs.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Data environment" href="../data/" />
    <link rel="prev" title="Heat diffusion mini-app" href="../miniapp/" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../" class="icon icon-home"> OpenMP for GPU offloading
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">The lessons</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../miniapp/">Heat diffusion mini-app</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Offloading to GPU</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#host-device-model">Host-device model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">Device execution model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#target-construct">TARGET construct</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-parallelism-on-the-target-device">Creating Parallelism on the Target Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#teams-construct">Teams construct</a></li>
<li class="toctree-l2"><a class="reference internal" href="#distribute-construct">Distribute construct</a></li>
<li class="toctree-l2"><a class="reference internal" href="#composite-directive">Composite directive</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data/">Data environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">OpenMP for GPU offloading</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
        
      <li>Offloading to GPU</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/ENCCS/openmp-gpu/blob/main/content/target.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="offloading-to-gpu">
<h1>Offloading to GPU<a class="headerlink" href="#offloading-to-gpu" title="Permalink to this headline">¶</a></h1>
<div class="admonition-prerequisites prerequisites admonition">
<p class="admonition-title">Prerequisites</p>
<p>more to add:</p>
<ol class="arabic simple">
<li><p>target update/ target declare</p></li>
<li><p>excercise</p></li>
<li><p>loop directive from v5.0</p></li>
</ol>
</div>
<div class="section" id="host-device-model">
<span id="id1"></span><h2>Host-device model<a class="headerlink" href="#host-device-model" title="Permalink to this headline">¶</a></h2>
<p>Since version 4.0 , OpenMP supports heterogeneous systems. OpenMP uses
<code class="docutils literal notranslate"><span class="pre">TARGET</span></code> construct to offload execution from the host to the target
device(s), and hence the directive name. In addition, the associated
data needs to be transferred to the device(s) as well.  Once
transferred, the target device owns the data and accesses by the host
<em>during the execution</em> of the target region is forbidden.</p>
<p>A host/device model is generally used by OpenMP for offloading:</p>
<blockquote>
<div><ul class="simple">
<li><p>normally there is only one single host: e.g. CPU</p></li>
<li><p>one or multiple target devices <em>of the same kind</em>: e.g. CPU, GPU, FPGA, …</p></li>
<li><p>unless with unified shared memory, the host and device have separate memory address space</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Under the following conditions, there will be <strong>NO data transfer</strong> to the device</p>
<ul class="simple">
<li><p>device is host</p></li>
<li><p>data already exists on the device from a previous execution</p></li>
</ul>
</div>
</div>
<div class="section" id="id2">
<h2>Device execution model<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>The execution on the device is host-centric</p>
<blockquote>
<div><p>1.the host creates the data environments on the device(s)
2.the host maps data to the device data environment, which is data movement to the device
3.the host offloads OpenMP target regions to the target device to be  executed
4.the host transfers data from the device to the host
5.The host destroys the data environment on the device.</p>
</div></blockquote>
</div>
<div class="section" id="target-construct">
<h2>TARGET construct<a class="headerlink" href="#target-construct" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> construct consists of a <em>target</em> directive and an
execution region. It is used to transfer both the control flow from
the host to the device and the data between the host and device.</p>
<div class="admonition-syntax typealong toggle-shown dropdown admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target [clauses]</span>
<span class="w">	</span><span class="n">structured</span><span class="o">-</span><span class="n">block</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="k">if</span><span class="p">([</span><span class="w"> </span><span class="nl">target</span><span class="p">:]</span><span class="w"> </span><span class="n">scalar</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">device</span><span class="p">(</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"> </span>
<span class="n">private</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">firstprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="nl">type</span><span class="p">:]</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">is_device_ptr</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">defaultmap</span><span class="p">(</span><span class="nl">tofrom</span><span class="p">:</span><span class="n">scalar</span><span class="p">)</span><span class="w"> </span>
<span class="n">nowait</span><span class="w"></span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="nl">type</span> <span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target [clauses]</span>
        <span class="n">structured</span><span class="o">-</span><span class="k">block</span>
<span class="c">!$omp end target</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span><span class="p">:</span>
<span class="k">if</span><span class="p">([</span> <span class="k">target</span><span class="p">:]</span> <span class="n">scalar</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span>
<span class="n">device</span><span class="p">(</span><span class="kt">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span> 
<span class="k">private</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">firstprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">map</span><span class="p">([</span><span class="n">map</span><span class="o">-</span><span class="k">type</span><span class="p">:]</span> <span class="n">list</span><span class="p">)</span>
<span class="n">is_device_ptr</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">defaultmap</span><span class="p">(</span><span class="n">tofrom</span><span class="p">:</span><span class="n">scalar</span><span class="p">)</span> 
<span class="n">nowait</span>
<span class="n">depend</span><span class="p">(</span><span class="n">dependence</span><span class="o">-</span><span class="k">type</span> <span class="p">:</span> <span class="n">list</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</div>
<p>Clauses:</p>
<blockquote>
<div><ul class="simple">
<li><p>device(scalar-integer-expression)</p></li>
<li><p>if(scalar-expression)
- If the scalar-expression evaluates to false then the target region is executed by the host device in the host data environment.</p></li>
<li><p>device(integer-expression)
– The value of the integer-expression selects the device when a device other than the default device is desired.</p></li>
<li><p>private(list) firstprivate(list)
– creates variables with the same name as those in the list on the device. In the case of firstprivate, the value of the variable on the host is copied into the private variable created on the device.</p></li>
<li><p>map([map-type:] list)
– map-type may be to, from, tofrom, or alloc. The clause defines how the variables in list are moved between the host and the device.</p></li>
<li><p>nowait
– The target task is deferred which means the host can run code in parallel to the target region on the device.</p></li>
</ul>
</div></blockquote>
<div class="admonition-example-target-construct exercise important admonition">
<p class="admonition-title">Example: target construct</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vec_mult</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">v1</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">v2</span><span class="p">[</span><span class="n">N</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="n">init</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp target</span>
<span class="w">   </span><span class="cp">#pragma omp parallel for private(i)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="n">output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">vec_mult</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
   <span class="kt">integer</span> <span class="kd">::</span>  <span class="n">i</span><span class="p">,</span><span class="n">N</span>
   <span class="kt">real</span>    <span class="kd">::</span>  <span class="n">p</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">v1</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">v2</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
   <span class="k">call </span><span class="n">init</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
   <span class="c">!$omp target</span>
   <span class="c">!$omp parallel do</span>
   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
      <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">v1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">v2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
   <span class="k">end do</span>
   <span class="c">!$omp end target</span>
   <span class="k">call </span><span class="n">output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">end subroutine</span>
</pre></div>
</div>
</div></div>
</div>
</div>
<div class="section" id="creating-parallelism-on-the-target-device">
<h2>Creating Parallelism on the Target Device<a class="headerlink" href="#creating-parallelism-on-the-target-device" title="Permalink to this headline">¶</a></h2>
<p>The target construct transfers the control flow to the device is
sequential and synchronous, and it is because OpenMP separates offload
and parallelism.  One needs to explicitly create parallel regions on
the target device to make efficient use of the device(s).</p>
</div>
<div class="section" id="teams-construct">
<h2>Teams construct<a class="headerlink" href="#teams-construct" title="Permalink to this headline">¶</a></h2>
<div class="admonition-syntax typealong toggle-shown dropdown admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp teams [clauses] </span>
<span class="w">	</span><span class="n">structured</span><span class="o">-</span><span class="n">block</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="n">num_teams</span><span class="p">(</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="n">thread_limit</span><span class="p">(</span><span class="n">integer</span><span class="o">-</span><span class="n">expression</span><span class="p">)</span><span class="w"></span>
<span class="k">default</span><span class="p">(</span><span class="n">shared</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">none</span><span class="p">)</span><span class="w"></span>
<span class="n">private</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">firstprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">shared</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">reduction</span><span class="p">(</span><span class="n">reduction</span><span class="o">-</span><span class="nl">identifier</span> <span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp teams [clauses]  </span>
        <span class="n">structured</span><span class="o">-</span><span class="k">block</span>
<span class="c">!$omp end teams</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>clause:
num_teams(integer-expression)
thread_limit(integer-expression)
default(shared | none)
private(list)
firstprivate(list)
shared(list)
reduction(reduction-identifier : list) 
</pre></div>
</div>
</div></div>
</div>
<p>The teams construct spawns a league of teams.  The maximum number of
teams is specified by the num_teams clause, Each team executes with
thread_limit threads Each team in the league starts with one master
thread and <em>concurrent (not parallel) execution</em> on each Streaming
Multiprocessors Threads in a team can synchronize but no
synchronization among teams The construct must be “perfectly” nested
in a target construct</p>
</div>
<div class="section" id="distribute-construct">
<h2>Distribute construct<a class="headerlink" href="#distribute-construct" title="Permalink to this headline">¶</a></h2>
<div class="admonition-syntax typealong toggle-shown dropdown admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp distribute [clauses]  </span>
<span class="w">	</span><span class="k">for</span><span class="o">-</span><span class="n">loops</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">clause</span><span class="p">:</span><span class="w"></span>
<span class="n">private</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">firstprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">lastprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="n">collapse</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="n">dist_schedule</span><span class="p">(</span><span class="n">kind</span><span class="p">[,</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">])</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp distribute [clauses]  </span>
        <span class="k">do</span><span class="o">-</span><span class="n">loops</span>
<span class="c">!$omp end distribute</span>
</pre></div>
</div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">clause</span><span class="p">:</span>
<span class="k">private</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">firstprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">lastprivate</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="n">collapse</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">dist_schedule</span><span class="p">(</span><span class="nb">kind</span><span class="p">[,</span> <span class="n">chunk_size</span><span class="p">])</span>
</pre></div>
</div>
</div></div>
</div>
<p>Loop iterations are workshared across the master threads in the teams,
but no worksharing within the threads in one team No implicit barrier
at the end of the construct no guarantee about the order the teams
will execute.</p>
<div class="admonition-example-teams-and-distribute-constructs exercise important admonition">
<p class="admonition-title">Example: teams and distribute constructs</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vec_mult</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">init</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp target teams map(to: v1[0:N], v2[:N]) map(from: p[0:N])</span>
<span class="w">   </span><span class="cp">#pragma omp distribute parallel for simd</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="n">output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">vec_mult</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
   <span class="kt">real</span>    <span class="kd">::</span>  <span class="n">p</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">v1</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">v2</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
   <span class="kt">integer</span> <span class="kd">::</span>  <span class="n">i</span>
   <span class="k">call </span><span class="n">init</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
   <span class="c">!$omp target teams map(to: v1, v2) map(from: p)</span>
   <span class="c">!$omp distribute parallel do simd</span>
         <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">v1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">v2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
         <span class="k">end do</span>
   <span class="c">!$omp end target teams</span>
   <span class="k">call </span><span class="n">output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">end subroutine</span>
</pre></div>
</div>
</div></div>
</div>
</div>
<div class="section" id="composite-directive">
<h2>Composite directive<a class="headerlink" href="#composite-directive" title="Permalink to this headline">¶</a></h2>
<p>It is convenient to use the composite construct</p>
<blockquote>
<div><ul class="simple">
<li><p>the code is more portable</p></li>
<li><p>let the compiler figure out the loop tiling since each compiler
supports different levels of parallelism</p></li>
<li><p>possible to reach good performance without composite directives</p></li>
</ul>
</div></blockquote>
<div class="admonition-syntax typealong toggle-shown dropdown admonition">
<p class="admonition-title">Syntax</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">C/C++</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target teams distribute parallel for simd [clauses] </span>
<span class="w">	</span><span class="k">for</span><span class="o">-</span><span class="n">loops</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!$omp target teams distribute parallel do simd [clauses]  </span>
        <span class="k">do</span><span class="o">-</span><span class="n">loops</span>
<span class="c">!$omp end target teams distribute parallel do simd</span>
</pre></div>
</div>
</div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../data/" class="btn btn-neutral float-right" title="Data environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../miniapp/" class="btn btn-neutral float-left" title="Heat diffusion mini-app" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, ENCCS and CSC.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>